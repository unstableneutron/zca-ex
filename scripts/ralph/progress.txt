# Ralph Progress Log
Started: 2026-01-16
Feature: ZcaEx Phase 7 Batches 3-12

## Codebase Patterns
- Use `use ZcaEx.Api.Factory` macro (imports encrypt_params/2, build_form_body/1)
- Return `{:ok, result} | {:error, ZcaEx.Error.t()}`
- Use session.zpw_service_map for base URLs: ["chat", Access.at(0)] for messaging, ["group", Access.at(0)] for groups
- Use Url.build/4 or Url.build_for_session/3 for URL construction
- Use AccountClient.post/5 or AccountClient.get/4 for requests
- Use Response.parse/2 to decrypt and parse responses
- CRITICAL: AccountClient first param must be session.uid for per-account cookie isolation
- JS source at ~/Projects/zca-js/src/apis/*.ts for exact API params

---

## 2026-01-16 - Batch 3: Friend Management
Thread: Thread: T-019bc5d4-2990-7451-a030-eb288046bac4
Task ID: 81

### Implemented
10 Friend Management endpoints:
- SendFriendRequest - /api/friend/sendreq (POST)
- AcceptFriendRequest - /api/friend/accept (POST)
- RejectFriendRequest - /api/friend/reject (POST)
- UndoFriendRequest - /api/friend/undo (POST)
- RemoveFriend - /api/friend/remove (POST)
- BlockUser - /api/friend/block (POST)
- UnblockUser - /api/friend/unblock (POST)
- FindUser - /api/friend/profile/get (GET with params in query)
- ChangeFriendAlias - /api/alias/update (GET, uses "alias" service)
- RemoveFriendAlias - /api/alias/remove (GET, uses "alias" service)

### Files Changed
Endpoints (lib/zca_ex/api/endpoints/):
- send_friend_request.ex, accept_friend_request.ex, reject_friend_request.ex, undo_friend_request.ex
- remove_friend.ex, block_user.ex, unblock_user.ex
- find_user.ex
- change_friend_alias.ex, remove_friend_alias.ex

Tests (test/zca_ex/api/endpoints/):
- Corresponding _test.exs for each endpoint (105 new tests)

### Learnings for Future Iterations
- **Alias service uses different URL**: `["alias", Access.at(0)]` not `["friend", ...]`
- **FindUser is GET not POST**: Params go in query string, use AccountClient.get
- **Phone normalization**: Vietnamese phones starting with "0" need "84" prefix
- **Always validate inputs**: Add validation for required params before processing
- **Support both string and atom keys in response transformation**: API may return either
- **Message coercion**: Use `to_string_safe/1` pattern to handle nil/non-string safely

---

## 2026-01-16 - Batch 4: Chat Settings
Thread: Thread: T-019bc5da-06f7-756e-b336-3a11fc7db86d
Task ID: 82

### Implemented
11 Chat Settings endpoints:
- SetMute - /api/social/profile/setmute (POST, "profile" service)
- GetMute - /api/social/profile/getmute (GET, "profile" service)
- SetPinnedConversations - /api/pinconvers/updatev2 (POST, "conversation" service)
- GetPinConversations - /api/pinconvers/list (GET, "conversation" service)
- SetArchivedConversations - /api/archivedchat/update (POST, "label" service)
- GetArchivedChatList - /api/archivedchat/list (GET, "label" service)
- SetHiddenConversations - /api/hiddenconvers/add-remove (POST, "conversation" service)
- GetHiddenConversations - /api/hiddenconvers/get-all (GET, "conversation" service)
- DeleteChat - /api/message/deleteconver (user) or /api/group/deleteconver (group)
- UpdateAutoDeleteChat - /api/conv/autodelete/updateConvers (POST, "conversation" service)
- GetAutoDeleteChat - /api/conv/autodelete/getConvers (GET, "conversation" service)

### Files Changed
Endpoints (lib/zca_ex/api/endpoints/):
- set_mute.ex, get_mute.ex
- set_pinned_conversations.ex, get_pin_conversations.ex
- set_archived_conversations.ex, get_archived_chat_list.ex
- set_hidden_conversations.ex, get_hidden_conversations.ex
- delete_chat.ex
- update_auto_delete_chat.ex, get_auto_delete_chat.ex

Tests (test/zca_ex/api/endpoints/):
- Corresponding _test.exs for each endpoint (156 new tests)

### Learnings for Future Iterations
- **Multiple services in one batch**: Different endpoints use different services (profile, conversation, label)
- **Service URL safety**: Always handle both list `[url | _]` and string `url` shapes from zpw_service_map
- **Default args must be trailing**: Elixir requires defaults at end of param list (not in middle)
- **Use Jason.encode/1 not encode!/1**: Avoid crashes; return `{:error, ...}` on encoding failures
- **Verify JS POST body format**: Some endpoints use form body, some have encrypted params in URL query
- **SetHiddenConversations uses JSON-stringified arrays**: `add_threads` and `del_threads` are JSON strings

---

## 2026-01-16 - Batch 5: Account & Profile
Thread: Thread: T-019bc5e1-5ab1-71c8-a9e0-2862effd581e
Task ID: 83

### Implemented
10 Account & Profile endpoints:
- FetchAccountInfo - /api/social/profile/me-v2 (GET, "profile" service)
- UpdateProfile - /api/social/profile/update (POST, "profile" service)
- ChangeAccountAvatar - /api/profile/upavatar (POST multipart, "file" service)
- DeleteAvatar - /api/social/del-avatars (GET, "profile" service)
- GetAvatarList - /api/social/avatar-list (GET, "profile" service)
- ReuseAvatar - /api/social/reuse-avatar (GET, "profile" service)
- UpdateActiveStatus - /api/social/profile/ping or /deactive (GET, "profile" service)
- UpdateSettings - /api/setting/update (GET, hardcoded wpa.chat.zalo.me)
- GetSettings - /api/setting/me (GET, hardcoded wpa.chat.zalo.me)
- UpdateLang - /api/social/profile/updatelang (GET, "profile" service)

### Files Changed
Endpoints (lib/zca_ex/api/endpoints/):
- fetch_account_info.ex, update_profile.ex, change_account_avatar.ex
- delete_avatar.ex, get_avatar_list.ex, reuse_avatar.ex
- update_active_status.ex, update_settings.ex, get_settings.ex, update_lang.ex

Tests (test/zca_ex/api/endpoints/):
- Corresponding _test.exs for each endpoint (133 new tests)

### Learnings for Future Iterations
- **Hardcoded URLs**: Settings endpoints use hardcoded `wpa.chat.zalo.me` instead of service map
- **File vs profile service**: Avatar upload uses "file" service, others use "profile"
- **UpdateActiveStatus uses different paths**: /ping for active=true, /deactive for active=false
- **Multipart uploads**: Use AccountClient.post_multipart/4, encrypted params go in URL query
- **Language validation**: Always validate to whitelist (:vi, :en) to avoid unexpected server behavior
- **Default args issue**: Elixir requires defaults at end - `def build_params(page \\ 1, count \\ 50, imei)` is invalid
- **Avoid Jason.encode!/1**: Use Jason.encode/1 with pattern match `{:ok, json}` to keep errors in-band

---

## 2026-01-16 - Batch 6: Polls & Reminders
Thread: Thread: T-019bc5e8-f90a-77d8-987f-115490324b94
Task ID: 84

### Implemented
12 Polls & Reminders endpoints:

**Poll endpoints (group service):**
- CreatePoll - /api/poll/create (POST)
- GetPollDetail - /api/poll/detail (POST)
- VotePoll - /api/poll/vote (GET)
- AddPollOptions - /api/poll/option/add (GET)
- LockPoll - /api/poll/end (POST)
- SharePoll - /api/poll/share (POST)

**Reminder endpoints (group_board service):**
- CreateReminder - /api/board/oneone/create (user) or /api/board/topic/createv2 (group) (POST)
- EditReminder - /api/board/oneone/update (user) or /api/board/topic/updatev2 (group) (POST)
- RemoveReminder - /api/board/oneone/remove (user) or /api/board/topic/remove (group) (POST)
- GetReminder - /api/board/topic/getReminder (GET)
- GetListReminder - /api/board/oneone/list (user) or /api/board/listReminder (group) (GET)
- GetReminderResponses - /api/board/topic/listResponseEvent (GET)

### Files Changed
Endpoints (lib/zca_ex/api/endpoints/):
- create_poll.ex, get_poll_detail.ex, vote_poll.ex, add_poll_options.ex, lock_poll.ex, share_poll.ex
- create_reminder.ex, edit_reminder.ex, remove_reminder.ex
- get_reminder.ex, get_list_reminder.ex, get_reminder_responses.ex

Tests (test/zca_ex/api/endpoints/):
- Corresponding _test.exs for each endpoint (161 new tests, total now 1222)

### Learnings for Future Iterations
- **poll_id is integer, not string**: JS uses `pollId: number` - validated as positive integer across all poll endpoints
- **Different services for polls vs reminders**: Polls use "group", reminders use "group_board"
- **Reminder endpoints have user/group variants**: Different URLs and params based on thread_type (:user | :group)
- **Always validate thread_type**: Add `validate_thread_type/1` to avoid CaseClauseError on invalid input
- **build_params returning {:ok, map()} not just map()**: When build_params uses Jason.encode, wrap return in {:ok, ...} and handle errors
- **Use Jason.encode/1 consistently**: Never use Jason.encode!/1 to keep error handling consistent
- **Nested JSON in reminders**: User reminders wrap params in objectData JSON string; group reminders have params inline
- **GetListReminder returns nested JSON**: Response data field is a JSON string that needs parsing again

---

## 2026-01-16 - Batch 7: Group Advanced
Thread: Thread: T-019bc5f3-d500-754f-81dd-9664e2517190
Task ID: 85

### Implemented
16 Group Advanced endpoints:
- GetGroupMembersInfo - /api/social/group/members (GET, "profile" service, appends "_0" to member IDs)
- GetGroupBlockedMember - /api/group/blockedmems/list (GET)
- AddGroupBlockedMember - /api/group/blockedmems/add (GET)
- RemoveGroupBlockedMember - /api/group/blockedmems/remove (GET)
- GetPendingGroupMembers - /api/group/pending-mems/list (GET)
- ReviewPendingMemberRequest - /api/group/pending-mems/review (GET, isApprove 1/0)
- InviteUserToGroups - /api/group/invite/multi (GET)
- EnableGroupLink - /api/group/link/new (GET)
- DisableGroupLink - /api/group/link/disable (GET, no imei per JS source)
- GetGroupLinkDetail - /api/group/link/detail (GET)
- GetGroupLinkInfo - /api/group/link/ginfo (GET)
- JoinGroupLink - /api/group/link/join (GET)
- GetGroupInviteBoxInfo - /api/group/inv-box/inv-info (GET, uses grId not grid)
- GetGroupInviteBoxList - /api/group/inv-box/list (GET)
- DeleteGroupInviteBox - /api/group/inv-box/mdel-inv (GET, JSON-stringified invitations)
- JoinGroupInviteBox - /api/group/inv-box/join (GET)

### Files Changed
Endpoints (lib/zca_ex/api/endpoints/):
- get_group_members_info.ex, get_group_blocked_member.ex, add_group_blocked_member.ex, remove_group_blocked_member.ex
- get_pending_group_members.ex, review_pending_member_request.ex, invite_user_to_groups.ex
- enable_group_link.ex, disable_group_link.ex, get_group_link_detail.ex, get_group_link_info.ex, join_group_link.ex
- get_group_invite_box_info.ex, get_group_invite_box_list.ex, delete_group_invite_box.ex, join_group_invite_box.ex

Tests (test/zca_ex/api/endpoints/):
- Corresponding _test.exs for each endpoint (152 new tests, total now 1374)

### Learnings for Future Iterations
- **GetGroupMembersInfo uses "profile" service, not "group"**: Different from all other group endpoints
- **GetGroupMembersInfo appends "_0" suffix**: member IDs need `_0` suffix if not already present
- **GetGroupInviteBoxInfo uses `grId` not `grid`**: Parameter naming exception
- **DisableGroupLink has no imei**: Unlike EnableGroupLink/GetGroupLinkDetail, per JS source
- **DeleteGroupInviteBox JSON-encodes invitations**: `invitations` param is JSON string of `[{grid: id}, ...]`
- **Strict boolean validation**: Use `when not is_boolean(param)` guard to reject truthy non-booleans
- **Consistent error codes**: Use `:invalid_input` for all validation errors
- **All 16 endpoints use GET**: Encrypted params go in URL query string, not POST body

---

## 2026-01-16 - Batch 8: Stickers & Media
Thread: Thread: T-019bc5fe-d4af-7743-91f0-226f63af4985
Task ID: 86

### Implemented
4 Stickers & Media endpoints (2 new, 2 already existed):
- GetStickers - /api/message/sticker/suggest/stickers (GET, "sticker" service) - searches stickers by keyword
- GetStickersDetail - /api/message/sticker/sticker_detail (GET, "sticker" service) - gets sticker details by ID
- ParseLink - (already implemented) /api/message/parselink
- GetQR - (already implemented) /api/friend/mget-qr

### Files Changed
New endpoints (lib/zca_ex/api/endpoints/):
- get_stickers.ex
- get_stickers_detail.ex

Tests (test/zca_ex/api/endpoints/):
- get_stickers_test.exs (18 tests)
- get_stickers_detail_test.exs (17 tests)

### Learnings for Future Iterations
- **Sticker service has stable fallback URL**: Use `https://sticker.zalo.me` when service not in map
- **Transform camelCase to snake_case**: Support both `cateId`/`:cateId` and `cate_id`/`:cate_id` keys for robustness
- **Validate whitespace in keywords**: Trim strings before checking emptiness for search endpoints
- **GetStickersDetail skips failures**: Like JS Promise.allSettled, continue on individual request failures and return partial results
- **Consistent service URL fallback**: Use fallback pattern (`_ -> "https://..."`) instead of raising for stable services

---

## 2026-01-16 - Batch 9: Notes & Labels
Thread: Thread: T-019bc610-e2c9-70ba-a692-5a8d02ad1236
Task ID: 87

### Implemented
7 Notes & Labels endpoints:

**Note endpoints (group_board service):**
- CreateNote - /api/board/topic/createv2 (POST, pinAct: 0=unpin, 1=pin)
- EditNote - /api/board/topic/updatev2 (POST, pinAct: 1=pin, 2=unpin)

**Label endpoints (label service):**
- GetLabels - /api/convlabel/get (GET)
- UpdateLabels - /api/convlabel/update (POST)

**Unread Mark endpoints (conversation service):**
- AddUnreadMark - /api/conv/addUnreadMark (POST)
- GetUnreadMark - /api/conv/getUnreadMark (GET)
- RemoveUnreadMark - /api/conv/removeUnreadMark (POST)

### Files Changed
Endpoints (lib/zca_ex/api/endpoints/):
- create_note.ex, edit_note.ex
- get_labels.ex, update_labels.ex
- add_unread_mark.ex, get_unread_mark.ex, remove_unread_mark.ex

Tests (test/zca_ex/api/endpoints/):
- Corresponding _test.exs for each endpoint (119 new tests, total now 1528)

### Learnings for Future Iterations
- **Default args must be trailing**: Use wrapper functions like `def create(a, b, session, creds), do: create(a, b, false, session, creds)` instead of `def create(a, b, pin? \\ false, session, creds)`
- **build_params returning {:ok, map} pattern**: When build_params may fail (e.g., JSON encoding), return `{:ok, params}` and use `with` chain
- **Use Error.new/3 consistently**: For validation errors: `Error.new(:api, msg, code: :invalid_input)`, for network: `Error.new(:network, msg, reason: reason)`
- **pinAct semantics differ between Create and Edit**: CreateNote uses 0=unpin/1=pin, EditNote uses 1=pin/2=unpin
- **labelData is JSON string in response**: Both GetLabels and UpdateLabels return labelData as JSON string needing parse
- **Unread mark nested param field**: param field contains JSON-stringified inner object with convsUser/convsGroup arrays
- **Response data may be string or map**: Transform functions handle both `data["field"]` and `data[:field]` keys

---
